<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>E = T</title>
<style>
  :root {
    --bg-dark: #000;
    --text-dark: #fff;
    --bg-light: #f0f0f0;
    --text-light: #111;
    --btn-dark: #333;
    --btn-light: #ddd;
    --btn-hover-dark: #555;
    --btn-hover-light: #bbb;
  }
  body[data-theme="dark"] {
    background: var(--bg-dark);
    color: var(--text-dark);
  }
  body[data-theme="light"] {
    background: var(--bg-light);
    color: var(--text-light);
  }
  body {
    font-family: Arial, sans-serif;
    margin:0; padding:20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    transition: background-color 0.3s, color 0.3s;
  }
  button {
    background: var(--btn-dark);
    color: var(--text-dark);
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    margin: 8px;
    font-size: 1.2rem;
    cursor: pointer;
    transition: background 0.3s;
  }
  body[data-theme="light"] button {
    background: var(--btn-light);
    color: var(--text-light);
  }
  button:hover, button:focus {
    background: var(--btn-hover-dark);
    outline: none;
  }
  body[data-theme="light"] button:hover, body[data-theme="light"] button:focus {
    background: var(--btn-hover-light);
  }
  input[type=range] {
    width: 150px;
    margin-left: 8px;
    vertical-align: middle;
  }
  .vol-control {
    margin: 12px 0;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 1.1rem;
  }
  #status {
    margin-top: 30px;
    font-weight: bold;
    min-height: 1.5em;
  }
  #clock {
    margin-top: 20px;
    font-size: 2rem;
    font-weight: bold;
    user-select: none;
  }
  #passwordScreen {
    position: fixed;
    inset: 0;
    background: inherit;
    color: inherit;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 10px;
  }
  #passwordInput {
    font-size: 1.5rem;
    padding: 10px;
    width: 180px;
    text-align: center;
    border-radius: 8px;
    border: 2px solid gray;
    background: transparent;
    color: inherit;
  }
  #passwordSubmit {
    font-size: 1.3rem;
  }
  #passwordError {
    color: #f44;
    min-height: 1.2em;
  }
  #mainUI {
    display: none;
    flex-direction: column;
    align-items: center;
  }
</style>
</head>
<body data-theme="dark">

<!-- Password Screen -->
<div id="passwordScreen" role="dialog" aria-modal="true" aria-labelledby="pwTitle">
  <h2 id="pwTitle">Entrez le code</h2>
  <input id="passwordInput" type="password" maxlength="4" inputmode="numeric" autocomplete="off" aria-describedby="passwordError" aria-label="Code secret" autofocus />
  <button id="passwordSubmit">Valider</button>
  <div id="passwordError" role="alert" aria-live="assertive"></div>
</div>

<!-- Main UI -->
<div id="mainUI" role="main" aria-live="polite" aria-atomic="true">
  <h1>E = T</h1>

  <button id="startBtn" aria-pressed="false">Démarrer</button>

  <div class="vol-control">
    🔊 Réaction :
    <input type="range" id="reactionVolume" min="0" max="1" step="0.01" value="1" aria-label="Volume réaction" />
    <span id="reactionVal">1.00</span>
  </div>

  <div class="vol-control">
    🎵 Audio mic actif :
    <input type="range" id="micAudioVolume" min="0" max="1" step="0.01" value="0.3" aria-label="Volume audio microphone actif" />
    <span id="micAudioVal">0.30</span>
  </div>

  <div class="vol-control">
    🔔 Clic :
    <input type="range" id="clickVolume" min="0" max="1" step="0.01" value="1" aria-label="Volume clic" />
    <span id="clickVal">1.00</span>
  </div>

  <div id="status">En attente...</div>
  <div id="clock" aria-label="Horloge">--:--:--</div>

  <button id="themeToggle" aria-pressed="false" aria-label="Changer mode clair/sombre">Changer mode clair/sombre</button>
</div>

<!-- Audio Elements -->
<audio id="clickSound" src="click.mp3" preload="auto"></audio>
<audio id="micActiveAudio" src="audio/mic_active_loop.mp3" preload="auto" loop></audio>

<script>
(() => {
  const PASSWORD = "8629";

  const reactionAudios = ["M/merci1.mp3"];

  // Elements
  const passwordScreen = document.getElementById("passwordScreen");
  const passwordInput = document.getElementById("passwordInput");
  const passwordSubmit = document.getElementById("passwordSubmit");
  const passwordError = document.getElementById("passwordError");

  const mainUI = document.getElementById("mainUI");
  const startBtn = document.getElementById("startBtn");
  const statusDiv = document.getElementById("status");
  const clock = document.getElementById("clock");
  const themeToggle = document.getElementById("themeToggle");

  const reactionVol = document.getElementById("reactionVolume");
  const micAudioVol = document.getElementById("micAudioVolume");
  const clickVol = document.getElementById("clickVolume");

  const reactionVal = document.getElementById("reactionVal");
  const micAudioVal = document.getElementById("micAudioVal");
  const clickVal = document.getElementById("clickVal");

  const clickSound = document.getElementById("clickSound");
  const micActiveAudio = document.getElementById("micActiveAudio");

  let recognition = null;
  let speakAudio = null;
  let isRunning = false;

  function updateVol(input, span) {
    span.textContent = (+input.value).toFixed(2);
    input.setAttribute("aria-valuenow", span.textContent);
  }

  reactionVol.oninput = () => {
    updateVol(reactionVol, reactionVal);
  };
  micAudioVol.oninput = () => {
    updateVol(micAudioVol, micAudioVal);
    micActiveAudio.volume = +micAudioVol.value;
  };
  clickVol.oninput = () => {
    updateVol(clickVol, clickVal);
    clickSound.volume = +clickVol.value;
  };

  function playClick() {
    clickSound.currentTime = 0;
    clickSound.volume = +clickVol.value;
    clickSound.play().catch(() => {});
  }

  function stopRecognition() {
    if (recognition) {
      recognition.onend = null;
      recognition.stop();
      recognition = null;
    }
    micActiveAudio.pause();
  }

  function startRecognition() {
    if (recognition) {
      recognition.stop();
      recognition = null;
    }
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      alert("❌ Reconnaissance non supportée");
      return;
    }
    recognition = new SR();
    recognition.lang = "fr-FR";
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onresult = (e) => {
      const text = e.results[e.results.length - 1][0].transcript.trim().toLowerCase();
      statusDiv.textContent = `🗣️ "${text}"`;

      stopRecognition();
      playReaction();
    };

    recognition.onend = () => {
      if (isRunning) {
        recognition.start();
      }
    };

    recognition.onerror = (e) => {
      console.error("Recognition error:", e.error);
      if (e.error === "not-allowed" || e.error === "service-not-allowed") {
        alert("❌ Permission micro refusée");
        stopRecognition();
        isRunning = false;
        startBtn.textContent = "Démarrer";
        startBtn.setAttribute("aria-pressed", "false");
        statusDiv.textContent = "Permission refusée";
      }
    };

    recognition.start();
    micActiveAudio.volume = +micAudioVol.value;
    micActiveAudio.play().catch(() => {});
  }

  function playReaction() {
    if (speakAudio) {
      speakAudio.pause();
      speakAudio = null;
    }
    micActiveAudio.pause();

    speakAudio = new Audio(reactionAudios[Math.floor(Math.random() * reactionAudios.length)]);
    speakAudio.volume = +reactionVol.value;
    speakAudio.play().catch(() => {});

    speakAudio.onended = () => {
      speakAudio = null;
      playClick();
      setTimeout(() => {
        if (isRunning) startRecognition();
      }, 300);
    };
  }

  startBtn.onclick = () => {
    playClick();
    isRunning = !isRunning;
    startBtn.textContent = isRunning ? "Arrêter" : "Démarrer";
    startBtn.setAttribute("aria-pressed", isRunning.toString());

    if (isRunning) {
      navigator.mediaDevices.getUserMedia({ audio: true }).then(() => {
        startRecognition();
        statusDiv.textContent = "🎤 En écoute...";
      }).catch(e => {
        alert("❌ Micro refusé : " + e.message);
        isRunning = false;
        startBtn.textContent = "Démarrer";
        startBtn.setAttribute("aria-pressed", "false");
        statusDiv.textContent = "En pause.";
      });
    } else {
      stopRecognition();
      speakAudio?.pause();
      statusDiv.textContent = "En pause.";
    }
  };

  themeToggle.onclick = () => {
    playClick();
    const currentTheme = document.body.getAttribute("data-theme");
    if (currentTheme === "dark") {
      document.body.setAttribute("data-theme", "light");
      themeToggle.textContent = "Mode Sombre";
      themeToggle.setAttribute("aria-pressed", "true");
    } else {
      document.body.setAttribute("data-theme", "dark");
      themeToggle.textContent = "Mode Clair";
      themeToggle.setAttribute("aria-pressed", "false");
    }
  };

  // Password logic
  passwordSubmit.onclick = () => {
    if (passwordInput.value === PASSWORD) {
      passwordError.textContent = "";
      passwordScreen.style.display = "none";
      mainUI.style.display = "flex";
      passwordInput.value = "";
      passwordInput.blur();
    } else {
      passwordError.textContent = "Code incorrect";
    }
  };
  passwordInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") passwordSubmit.click();
  });

  // Clock update
  setInterval(() => {
    const now = new Date();
    clock.textContent = now.toLocaleTimeString("fr-FR");
  }, 1000);
})();
</script>

</body>
</html>
