<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Mic Keyword Response</title>
  <style>
    body {
      background: black;
      color: white;
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    button {
      font-size: 18px;
      margin: 10px;
      padding: 10px 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h1>🎤 Mic Keyword Response 0.9</h1>
<button onclick="startProcess()">🎧 Démarrer</button>
<div id="status">Prêt.</div>
<script>
  // No keyword map anymore
  const fallbackClips = ["reaction 2.mp3",
                         "P1.mp3", "P2.1.mp3",
                         "positifR1.mp3",
                         "M/1P V.mp3",
                         "M/merci1.mp3",
                         "M/merci2.mp3",
                         "M/40s2B AH.mp3",
                         "M/merci3.mp3",
                         "M/merci4.mp3"
                        ];
  const youSaidClip = ["reaction 1.mp3"];
  const RECORD_DURATION = 3000;

  // Mic start sound placeholder
  const micStartSound = new Audio("click.mp3");
  micStartSound.volume = 0.30; // low volume

  let mediaRecorder;
  let recordedChunks = [];
  let recordedBlob;

  function startProcess() {
    micStartSound.play(); // Play sound when mic activates
    recordedChunks = [];
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
      mediaRecorder.onstop = () => {
        recordedBlob = new Blob(recordedChunks, { type: 'audio/webm' });
        playYouSaidSequence();
      };
      mediaRecorder.start();
      document.getElementById("status").textContent = "🎙️ Enregistrement...";
      setTimeout(() => mediaRecorder.stop(), RECORD_DURATION);
    });
  }

  function playYouSaidSequence() {
    document.getElementById("status").textContent = "▶️ Lecture : 'Tu as dit...'";
    const youSaid = new Audio(youSaidClip);
    youSaid.onended = () => playUserRecording();
    youSaid.play();
  }

  function playUserRecording() {
    document.getElementById("status").textContent = "▶️ Lecture de votre voix...";
    const playback = new Audio(URL.createObjectURL(recordedBlob));
    playback.onended = () => {
      document.getElementById("status").textContent = "⏭️ Réaction...";
      playResponse(randomFromArray(fallbackClips));
    };
    playback.play();
  }

  function playResponse(path) {
    document.getElementById("status").textContent = "▶️ Réponse : " + path;
    const response = new Audio(path);
    response.onended = () => startProcess();
    response.play();
  }

  function randomFromArray(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }
</script>
</body>
</html>


