<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistant Vocal</title>
  <style>
    body {
      background: black;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    button {
      margin: 10px;
      padding: 12px 24px;
      font-size: 1.1rem;
      border: none;
      border-radius: 8px;
      background: #333;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #555;
    }
    input[type=range] {
      width: 150px;
      vertical-align: middle;
    }
    .vol-label {
      display: block;
      margin-top: 15px;
    }
    #overlay {
      position: fixed;
      inset: 0;
      background: black;
      color: white;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 3em;
      z-index: 9999;
      flex-direction: column;
    }
    #clock {
      font-size: 3em;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<h1>E = T</h1>

<button onclick="toggleOverlay()">🕶️ Plein écran</button>
<button id="startBtn">Démarrer</button>
<button onclick="playNextInstrumental()">⏭️ Changer Instrumental</button>

<div class="vol-label">
  🔊 Volume Réaction :
  <input type="range" id="reactionVolume" min="0" max="1" step="0.01" value="1" />
  <span id="reactionVal">1.00</span>
</div>

<div class="vol-label">
  🔉 Volume Filler Voice :
  <input type="range" id="fillerVoiceVolume" min="0" max="1" step="0.01" value="0.3" />
  <span id="fillerVoiceVal">0.30</span>
</div>

<div class="vol-label">
  🎼 Volume Filler Music :
  <input type="range" id="fillerMusicVolume" min="0" max="1" step="0.01" value="0.2" />
  <span id="fillerMusicVal">0.20</span>
</div>

<div class="vol-label">
  🎶 Volume Instrumental Music :
  <input type="range" id="instrumentalVolume" min="0" max="1" step="0.01" value="0.1" />
  <span id="instrumentalVal">0.10</span>
</div>

<div id="status">En attente...</div>

<div id="overlay">
  <div>🕶️ Assistant</div>
  <div id="clock">--:--:--</div>
  <button onclick="toggleOverlay()">🟢 Ouvrir</button>
</div>

<script>
// === SOURCES AUDIO ===
const reactionAudios = [
  "M/merci1.mp3"
];

const fillerVoices = [
  "M/merci2.mp3", "M/merci3.mp3", "M/merci4.mp3"
];

const fillerMusicTracks = [
  "audio/Bet You Can.mp3",
  "audio/Dance of the Sugar Plum Fairy.mp3"
];

const instrumentalMusicTracks = [
  "audio/Exhilarate.mp3",
  "audio/Frost Waltz.mp3",
  "audio/Gymnopedie No 1.mp3",
  "audio/Gymnopedie No 2.mp3",
  "audio/Happy Boy End Theme.mp3"
];

// === ÉLÉMENTS DOM ===
const startBtn = document.getElementById("startBtn");
const statusDiv = document.getElementById("status");

const reactionVolumeSlider = document.getElementById("reactionVolume");
const fillerVoiceVolumeSlider = document.getElementById("fillerVoiceVolume");
const fillerMusicVolumeSlider = document.getElementById("fillerMusicVolume");
const instrumentalVolumeSlider = document.getElementById("instrumentalVolume");

const reactionVal = document.getElementById("reactionVal");
const fillerVoiceVal = document.getElementById("fillerVoiceVal");
const fillerMusicVal = document.getElementById("fillerMusicVal");
const instrumentalVal = document.getElementById("instrumentalVal");

const overlay = document.getElementById("overlay");
const clock = document.getElementById("clock");

// === AUDIO OBJECTS ===
let speakAudio = null;
let fillerVoice = new Audio();
let fillerMusic = new Audio();
let instrumentalMusic = new Audio();
let recognition;
let isRunning = false;

let instrumentalIndex = 0;

// === VOLUME ===
reactionVolumeSlider.oninput = () => {
  reactionVal.textContent = (+reactionVolumeSlider.value).toFixed(2);
  if (speakAudio) speakAudio.volume = +reactionVolumeSlider.value;
};
fillerVoiceVolumeSlider.oninput = () => {
  fillerVoiceVal.textContent = (+fillerVoiceVolumeSlider.value).toFixed(2);
  fillerVoice.volume = +fillerVoiceVolumeSlider.value;
};
fillerMusicVolumeSlider.oninput = () => {
  fillerMusicVal.textContent = (+fillerMusicVolumeSlider.value).toFixed(2);
  fillerMusic.volume = +fillerMusicVolumeSlider.value;
};
instrumentalVolumeSlider.oninput = () => {
  instrumentalVal.textContent = (+instrumentalVolumeSlider.value).toFixed(2);
  instrumentalMusic.volume = +instrumentalVolumeSlider.value;
};

// === FILLER VOICE LOOP ===
fillerVoice.loop = false;
fillerVoice.onended = () => {
  if (!speakAudio) playRandomFillerVoice();
};

// === FILLER MUSIC LOOP ===
fillerMusic.loop = true;

// === INSTRUMENTAL MUSIC LOOP ===
instrumentalMusic.loop = false;
instrumentalMusic.onended = () => {
  playNextInstrumental();
};

function playRandomFillerVoice() {
  if (speakAudio) return; // pas jouer si réaction en cours
  const track = fillerVoices[Math.floor(Math.random() * fillerVoices.length)];
  fillerVoice.src = track;
  fillerVoice.volume = +fillerVoiceVolumeSlider.value;
  fillerVoice.play().catch(() => {});
  if (fillerMusic.paused) {
    fillerMusic.src = fillerMusicTracks[0];
    fillerMusic.volume = +fillerMusicVolumeSlider.value;
    fillerMusic.play().catch(() => {});
  }
}

function playNextInstrumental() {
  instrumentalIndex = (instrumentalIndex + 1) % instrumentalMusicTracks.length;
  const src = instrumentalMusicTracks[instrumentalIndex];
  instrumentalMusic.src = src;
  instrumentalMusic.volume = +instrumentalVolumeSlider.value;
  instrumentalMusic.play().catch(() => {});
}

// === REACTION AUDIO ===
function playReaction() {
  const clip = reactionAudios[Math.floor(Math.random() * reactionAudios.length)];
  if (speakAudio) {
    speakAudio.pause();
    speakAudio.currentTime = 0;
    speakAudio = null;
  }
  speakAudio = new Audio(clip);
  speakAudio.volume = +reactionVolumeSlider.value;

  // Ne pas couper le filler et instrumental, on joue en même temps
  speakAudio.play().catch(() => {});

  speakAudio.onended = () => {
    speakAudio = null;
    if (fillerVoice.paused) playRandomFillerVoice();
    if (fillerMusic.paused) {
      fillerMusic.src = fillerMusicTracks[0];
      fillerMusic.volume = +fillerMusicVolumeSlider.value;
      fillerMusic.play().catch(() => {});
    }
  };
}

// === RECONNAISSANCE VOCALE ===
function startRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    alert("❌ SpeechRecognition non supporté");
    return;
  }
  recognition = new SR();
  recognition.lang = "fr-FR";
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = e => {
    const text = e.results[e.results.length - 1][0].transcript.trim().toLowerCase();
    statusDiv.textContent = `🗣️ "${text}"`;
    playReaction();
  };

  recognition.onend = () => {
    if (isRunning) recognition.start();
  };

  recognition.start();
}

// === DÉMARRER / ARRÊTER ===
startBtn.onclick = () => {
  isRunning = !isRunning;
  if (isRunning) {
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      stream.getTracks().forEach(track => track.stop());
      startRecognition();
      playRandomFillerVoice();
      fillerMusic.src = fillerMusicTracks[0];
      fillerMusic.volume = +fillerMusicVolumeSlider.value;
      fillerMusic.loop = true;
      fillerMusic.play().catch(() => {});
      instrumentalIndex = 0;
      instrumentalMusic.src = instrumentalMusicTracks[instrumentalIndex];
      instrumentalMusic.volume = +instrumentalVolumeSlider.value;
      instrumentalMusic.play().catch(() => {});
      startBtn.textContent = "Arrêter";
      statusDiv.textContent = "🎤 En écoute...";
    }).catch(e => {
      alert("❌ Micro refusé : " + e.message);
      isRunning = false;
    });
  } else {
    recognition?.stop();
    fillerVoice.pause();
    fillerMusic.pause();
    instrumentalMusic.pause();
    speakAudio?.pause();
    startBtn.textContent = "Démarrer";
    statusDiv.textContent = "En pause.";
  }
};

// === OVERLAY ET HORLOGE ===
function toggleOverlay() {
  overlay.style.display = overlay.style.display === "flex" ? "none" : "flex";
}

setInterval(() => {
  const now = new Date();
  const hh = now.getHours().toString().padStart(2, "0");
  const mm = now.getMinutes().toString().padStart(2, "0");
  const ss = now.getSeconds().toString().padStart(2, "0");
  clock.textContent = `${hh}:${mm}:${ss}`;
}, 1000);
</script>

</body>
</html>
