<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>E = T</title>
  <style>
    body {
      background: black;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    button {
      margin: 10px;
      padding: 12px 24px;
      font-size: 1.1rem;
      border: none;
      border-radius: 8px;
      background: #333;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #555;
    }
    input[type=range] {
      width: 150px;
      vertical-align: middle;
    }
    .vol-label {
      display: block;
      margin-top: 15px;
    }
    #clock {
      font-size: 2em;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<h1>E = T</h1>

<button onclick="playClick(); toggleOverlay()">ğŸ•¶ï¸ Plein Ã©cran</button>
<button id="startBtn" onclick="playClick()">DÃ©marrer</button>
<button onclick="playClick(); playInstrumental()">â­ï¸ Changer Instrumental</button>

<div class="vol-label">ğŸ”Š Volume RÃ©action :
  <input type="range" id="reactionVolume" min="0" max="1" step="0.01" value="1">
  <span id="reactionVal">1.00</span>
</div>

<div class="vol-label">ğŸ”‰ Volume Filler :
  <input type="range" id="fillerVolume" min="0" max="1" step="0.01" value="0.3">
  <span id="fillerVal">0.30</span>
</div>

<div class="vol-label">ğŸ¼ Volume Instrumental :
  <input type="range" id="musicVolume" min="0" max="1" step="0.01" value="0.1">
  <span id="musicVal">0.10</span>
</div>

<div class="vol-label">ğŸ”” Volume Click :
  <input type="range" id="clickVolume" min="0" max="1" step="0.01" value="1">
  <span id="clickVal">1.00</span>
</div>

<div id="status">En attente...</div>
<div id="clock">--:--:--</div>

<audio id="clickSound" src="click.mp3" preload="auto"></audio>

<script>
const reactionAudios = ["M/merci1.mp3"];
const fillerVoices = ["M/merci2.mp3"];
const fillerMusicTracks = ["audio/Bet You Can.mp3"];
const musicTracks = [
  "audio/Exhilarate.mp3", "audio/Frost Waltz.mp3", "audio/Gymnopedie No 1.mp3",
  "audio/Gymnopedie No 2.mp3", "audio/Happy Boy End Theme.mp3",
  "audio/Hidden Agenda.mp3", "audio/Latin Industries.mp3", "audio/Pump.mp3"
];

const startBtn = document.getElementById("startBtn");
const statusDiv = document.getElementById("status");
const clock = document.getElementById("clock");

const reactionVol = document.getElementById("reactionVolume");
const fillerVol = document.getElementById("fillerVolume");
const musicVol = document.getElementById("musicVolume");
const clickVol = document.getElementById("clickVolume");

const reactionVal = document.getElementById("reactionVal");
const fillerVal = document.getElementById("fillerVal");
const musicVal = document.getElementById("musicVal");
const clickVal = document.getElementById("clickVal");

const clickSound = document.getElementById("clickSound");

let speakAudio = null;
let fillerVoice = new Audio();
let fillerMusic = new Audio();
let musicAudio = new Audio();
let recognition;
let isRunning = false;

fillerVoice.loop = false;
fillerMusic.loop = true;
musicAudio.loop = false;

reactionVol.oninput = () => reactionVal.textContent = (+reactionVol.value).toFixed(2);
fillerVol.oninput = () => {
  fillerVal.textContent = (+fillerVol.value).toFixed(2);
  fillerVoice.volume = +fillerVol.value;
  fillerMusic.volume = +fillerVol.value;
};
musicVol.oninput = () => {
  musicVal.textContent = (+musicVol.value).toFixed(2);
  musicAudio.volume = +musicVol.value;
};
clickVol.oninput = () => {
  clickVal.textContent = (+clickVol.value).toFixed(2);
  clickSound.volume = +clickVol.value;
};

function playClick() {
  clickSound.currentTime = 0;
  clickSound.volume = +clickVol.value;
  clickSound.play().catch(() => {});
}

function playInstrumental() {
  const src = musicTracks[Math.floor(Math.random() * musicTracks.length)];
  musicAudio.src = src;
  musicAudio.volume = +musicVol.value;
  musicAudio.play().catch(() => {});
}
musicAudio.onended = playInstrumental;

fillerVoice.onended = () => {
  if (!speakAudio) loopFiller();
};

function loopFiller() {
  if (speakAudio) return;
  const voice = fillerVoices[Math.floor(Math.random() * fillerVoices.length)];
  const music = fillerMusicTracks[Math.floor(Math.random() * fillerMusicTracks.length)];

  fillerVoice.src = voice;
  fillerVoice.volume = +fillerVol.value;
  fillerVoice.play().catch(() => {});

  fillerMusic.src = music;
  fillerMusic.volume = +fillerVol.value;
  fillerMusic.play().catch(() => {});
}

function playReaction() {
  if (speakAudio) {
    speakAudio.pause();
    speakAudio = null;
  }

  fillerVoice.pause();
  fillerMusic.pause();
  musicAudio.pause();
  stopRecognition();

  speakAudio = new Audio(reactionAudios[Math.floor(Math.random() * reactionAudios.length)]);
  speakAudio.volume = +reactionVol.value;
  speakAudio.play().catch(() => {});

  speakAudio.onended = () => {
    speakAudio = null;
    loopFiller();
    playInstrumental();
    playClick();
    setTimeout(() => {
      playClick();
      startRecognition();
    }, 3000);
  };
}

function startRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return alert("âŒ Reconnaissance non supportÃ©e");
  recognition = new SR();
  recognition.lang = "fr-FR";
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = e => {
    const text = e.results[e.results.length - 1][0].transcript.trim().toLowerCase();
    statusDiv.textContent = `ğŸ—£ï¸ "${text}"`;
    playReaction();
  };

  recognition.onend = () => { if (isRunning) recognition.start(); };
  recognition.start();
}

startBtn.onclick = () => {
  isRunning = !isRunning;
  if (isRunning) {
    navigator.mediaDevices.getUserMedia({ audio: true }).then(s => {
      s.getTracks().forEach(t => t.stop());
      startRecognition();
      loopFiller();
      playInstrumental();
      startBtn.textContent = "ArrÃªter";
      statusDiv.textContent = "ğŸ¤ En Ã©coute...";
    }).catch(e => alert("âŒ Micro refusÃ© : " + e.message));
  } else {
    recognition?.stop();
    fillerVoice.pause();
    fillerMusic.pause();
    speakAudio?.pause();
    musicAudio.pause();
    startBtn.textContent = "DÃ©marrer";
    statusDiv.textContent = "En pause.";
  }
};

function toggleOverlay() {
  alert("Mode plein Ã©cran non implÃ©mentÃ© ici.");
}

setInterval(() => {
  const now = new Date();
  clock.textContent = now.toLocaleTimeString("fr-FR");
}, 1000);
</script>

</body>
</html>
