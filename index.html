<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Assistant Vocal Simple</title>
<style>
  body {
    background: black;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 30px;
  }
  #passwordScreen, #mainUI {
    max-width: 300px;
    margin: auto;
  }
  input {
    font-size: 1.3rem;
    padding: 8px;
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 10px;
  }
  button {
    font-size: 1.3rem;
    padding: 10px 20px;
    background: #333;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  button:hover {
    background: #555;
  }
  #status {
    margin-top: 25px;
    font-weight: bold;
    min-height: 1.5em;
  }
  #clock {
    margin-top: 15px;
    font-size: 1.8rem;
    user-select: none;
  }
</style>
</head>
<body>

<div id="passwordScreen">
  <h2>Entrez le code</h2>
  <input id="passwordInput" type="password" maxlength="4" autocomplete="off" autofocus placeholder="Code secret" />
  <button id="passwordSubmit">Valider</button>
  <div id="passwordError" style="color: red; min-height: 1.2em;"></div>
</div>

<div id="mainUI" style="display:none;">
  <button id="startBtn">Démarrer</button>
  <div id="status">En attente...</div>
  <div id="clock">--:--:--</div>
  <audio id="reactionAudio" src="M/merci1.mp3" preload="auto"></audio>
</div>

<script>
(() => {
  const PASSWORD = "8629";
  const passwordScreen = document.getElementById("passwordScreen");
  const passwordInput = document.getElementById("passwordInput");
  const passwordSubmit = document.getElementById("passwordSubmit");
  const passwordError = document.getElementById("passwordError");

  const mainUI = document.getElementById("mainUI");
  const startBtn = document.getElementById("startBtn");
  const statusDiv = document.getElementById("status");
  const clock = document.getElementById("clock");
  const reactionAudio = document.getElementById("reactionAudio");

  let recognition = null;
  let isRunning = false;
  const isAndroid = /android/i.test(navigator.userAgent);

  function startRecognition() {
    if (recognition) {
      recognition.stop();
      recognition = null;
    }
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      alert("Reconnaissance non supportée");
      return;
    }
    recognition = new SR();
    recognition.lang = "fr-FR";
    recognition.continuous = !isAndroid;
    recognition.interimResults = false;

    recognition.onresult = (e) => {
      const text = e.results[e.results.length -1][0].transcript.trim();
      statusDiv.textContent = `🗣️ "${text}"`;
      recognition.stop();
      playReaction();
    };

    recognition.onend = () => {
      if (isRunning && reactionAudio.paused) {
        recognition.start();
        statusDiv.textContent = "🎤 En écoute...";
      }
    };

    recognition.onerror = (e) => {
      statusDiv.textContent = `Erreur : ${e.error}`;
      isRunning = false;
      startBtn.textContent = "Démarrer";
    };

    try {
      recognition.start();
      statusDiv.textContent = "🎤 En écoute...";
    } catch {}
  }

  function stopRecognition() {
    if (recognition) {
      recognition.stop();
      recognition = null;
    }
  }

  function playReaction() {
    reactionAudio.play().catch(() => {});
    reactionAudio.onended = () => {
      if (isRunning) {
        startRecognition();
      }
    };
  }

  startBtn.onclick = () => {
    isRunning = !isRunning;
    if (isRunning) {
      navigator.mediaDevices.getUserMedia({audio:true}).then(() => {
        startRecognition();
        startBtn.textContent = "Arrêter";
      }).catch(e => {
        alert("Micro refusé : " + e.message);
        isRunning = false;
        startBtn.textContent = "Démarrer";
        statusDiv.textContent = "En pause.";
      });
    } else {
      stopRecognition();
      reactionAudio.pause();
      reactionAudio.currentTime = 0;
      startBtn.textContent = "Démarrer";
      statusDiv.textContent = "En pause.";
    }
  };

  passwordSubmit.onclick = () => {
    if (passwordInput.value === PASSWORD) {
      passwordError.textContent = "";
      passwordScreen.style.display = "none";
      mainUI.style.display = "block";
      passwordInput.value = "";
      passwordInput.blur();
    } else {
      passwordError.textContent = "Code incorrect";
    }
  };

  passwordInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") passwordSubmit.click();
  });

  setInterval(() => {
    clock.textContent = new Date().toLocaleTimeString("fr-FR");
  }, 1000);
})();
</script>

</body>
</html>
