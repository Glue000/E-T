<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>E = T</title>
  <style>
    body {
      background: black;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    button {
      margin: 10px;
      padding: 12px 24px;
      font-size: 1.1rem;
      border: none;
      border-radius: 8px;
      background: #333;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #555;
    }
    input[type=range] {
      width: 150px;
      vertical-align: middle;
    }
    .vol-label {
      display: block;
      margin-top: 15px;
    }
    #status {
      margin-top: 20px;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>

<h1>E = T</h1>
<button id="startBtn">D√©marrer</button>
<button id="skipInstrumentalBtn">‚è≠Ô∏è Passer Musique</button>

<div class="vol-label">üîä Volume R√©action :
  <input type="range" id="reactionVolume" min="0" max="1" step="0.01" value="1" />
  <span id="reactionVal">1.00</span>
</div>

<div class="vol-label">üîâ Volume Filler :
  <input type="range" id="fillerVolume" min="0" max="1" step="0.01" value="0.3" />
  <span id="fillerVal">0.30</span>
</div>

<div class="vol-label">üéº Volume Musique Instrumentale :
  <input type="range" id="musicVolume" min="0" max="1" step="0.01" value="0.1" />
  <span id="musicVal">0.10</span>
</div>

<div id="status">En attente...</div>

<script>
  // === Sources audio ===
  const reactionAudios = [
    "M/merci1.mp3"
    // Ajoute d'autres clips si besoin
  ];
  const fillerVoices = [
    "M/merci2.mp3", "audio/a3.mp3", "audio/a4.mp3", "audio/a5.mp3"
  ];
  const fillerMusicTracks = [
    "audio/Bet You Can.mp3"
  ];
  const instrumentalMusicTracks = [
    "audio/Dance of the Sugar Plum Fairy.mp3",
    "audio/Exhilarate.mp3",
    "audio/Frost Waltz.mp3",
    "audio/Gymnopedie No 1.mp3",
    "audio/Gymnopedie No 2.mp3",
    "audio/Happy Boy End Theme.mp3",
    "audio/Hidden Agenda.mp3",
    "audio/Latin Industries.mp3",
    "audio/Pump.mp3"
  ];

  // === √âl√©ments DOM ===
  const startBtn = document.getElementById("startBtn");
  const skipInstrBtn = document.getElementById("skipInstrumentalBtn");
  const statusDiv = document.getElementById("status");

  const reactionVolSlider = document.getElementById("reactionVolume");
  const fillerVolSlider = document.getElementById("fillerVolume");
  const musicVolSlider = document.getElementById("musicVolume");

  const reactionVal = document.getElementById("reactionVal");
  const fillerVal = document.getElementById("fillerVal");
  const musicVal = document.getElementById("musicVal");

  // === Audio objects ===
  let recognition;
  let isRunning = false;

  let speakAudio = null;
  let fillerVoice = new Audio();
  let fillerMusic = new Audio();
  let instrumentalMusic = new Audio();

  // === Setup volumes and UI update ===
  function updateVolumes() {
    reactionVal.textContent = (+reactionVolSlider.value).toFixed(2);
    fillerVal.textContent = (+fillerVolSlider.value).toFixed(2);
    musicVal.textContent = (+musicVolSlider.value).toFixed(2);

    if (speakAudio) speakAudio.volume = +reactionVolSlider.value;
    fillerVoice.volume = +fillerVolSlider.value;
    fillerMusic.volume = +fillerVolSlider.value;
    instrumentalMusic.volume = +musicVolSlider.value;
  }
  reactionVolSlider.oninput = updateVolumes;
  fillerVolSlider.oninput = updateVolumes;
  musicVolSlider.oninput = updateVolumes;

  // === Loop filler voice + filler music ===
  fillerVoice.loop = false;
  fillerVoice.onended = () => {
    if (!speakAudio) playNextFillerVoice();
  };

  fillerMusic.loop = true;

  function playNextFillerVoice() {
    if (speakAudio) return; // ne pas jouer filler si r√©action en cours
    const src = fillerVoices[Math.floor(Math.random() * fillerVoices.length)];
    fillerVoice.src = src;
    fillerVoice.volume = +fillerVolSlider.value;
    fillerVoice.play().catch(() => {});
  }

  function playFillerMusic() {
    fillerMusic.src = fillerMusicTracks[0]; // un seul morceau pour filler music
    fillerMusic.loop = true;
    fillerMusic.volume = +fillerVolSlider.value;
    fillerMusic.play().catch(() => {});
  }

  // === Instrumental music loop + bouton skip ===
  instrumentalMusic.loop = false;
  instrumentalMusic.onended = playNextInstrumental;

  function playNextInstrumental() {
    const src = instrumentalMusicTracks[Math.floor(Math.random() * instrumentalMusicTracks.length)];
    instrumentalMusic.src = src;
    instrumentalMusic.volume = +musicVolSlider.value;
    instrumentalMusic.play().catch(() => {});
  }

  skipInstrBtn.onclick = () => {
    playNextInstrumental();
  };

  // === Play reaction audio ===
  function playReaction() {
    if (speakAudio) {
      speakAudio.pause();
      speakAudio.currentTime = 0;
    }
    speakAudio = new Audio(reactionAudios[Math.floor(Math.random() * reactionAudios.length)]);
    speakAudio.volume = +reactionVolSlider.value;

    // Stop filler and instrumental music
    fillerVoice.pause();
    fillerMusic.pause();
    instrumentalMusic.pause();

    speakAudio.play().catch(() => {});
    speakAudio.onended = () => {
      speakAudio = null;
      playNextFillerVoice();
      playFillerMusic();
      playNextInstrumental();
    };
  }

  // === Speech recognition ===
  function startRecognition() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      alert("Reconnaissance vocale non support√©e");
      return;
    }
    recognition = new SR();
    recognition.lang = "fr-FR";
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      const text = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
      statusDiv.textContent = `üó£Ô∏è "${text}"`;
      playReaction();
    };

    recognition.onerror = (event) => {
      if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
        statusDiv.textContent = "Permission microphone refus√©e.";
        stopRecognition();
        isRunning = false;
        startBtn.textContent = "D√©marrer";
      }
    };

    recognition.onend = () => {
      if (isRunning) recognition.start();
    };

    recognition.start();
  }

  function stopRecognition() {
    if (recognition) recognition.stop();
  }

  // === Start / Stop app ===
  startBtn.onclick = () => {
    if (isRunning) {
      stopRecognition();
      stopAllAudio();
      startBtn.textContent = "D√©marrer";
      statusDiv.textContent = "Arr√™t√©.";
      isRunning = false;
    } else {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          stream.getTracks().forEach(t => t.stop());
          startRecognition();
          playNextFillerVoice();
          playFillerMusic();
          playNextInstrumental();
          startBtn.textContent = "Arr√™ter";
          statusDiv.textContent = "üé§ En √©coute...";
          isRunning = true;
        })
        .catch(err => {
          alert("Micro non autoris√© : " + err.message);
        });
    }
  };

  function stopAllAudio() {
    if (speakAudio) {
      speakAudio.pause();
      speakAudio = null;
    }
    fillerVoice.pause();
    fillerMusic.pause();
    instrumentalMusic.pause();
  }

  // Mise √† jour initiale des volumes
  updateVolumes();
</script>

</body>
</html>
