<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>E = T - Simple</title>
<style>
  body[data-theme="dark"] {
    background: black;
    color: white;
  }
  body[data-theme="light"] {
    background: white;
    color: black;
  }
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    transition: background-color 0.3s, color 0.3s;
  }
  button {
    font-size: 1.2rem;
    margin: 10px;
    padding: 10px 20px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
  }
  #passwordScreen {
    position: fixed;
    inset: 0;
    background: inherit;
    color: inherit;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 10px;
  }
  #passwordInput {
    font-size: 1.5rem;
    padding: 8px;
    width: 150px;
    text-align: center;
  }
  #passwordError {
    color: red;
    min-height: 1.2em;
  }
  #mainUI {
    display: none;
    flex-direction: column;
    align-items: center;
  }
  #status {
    margin-top: 30px;
    font-weight: bold;
    min-height: 1.5em;
  }
  #clock {
    margin-top: 20px;
    font-size: 2rem;
    font-weight: bold;
    user-select: none;
  }
</style>
</head>
<body data-theme="dark">

<div id="passwordScreen" role="dialog" aria-modal="true" aria-labelledby="pwTitle">
  <h2 id="pwTitle">Entrez le code</h2>
  <input id="passwordInput" type="password" maxlength="4" inputmode="numeric" autocomplete="off" aria-label="Code secret" autofocus />
  <button id="passwordSubmit">Valider</button>
  <div id="passwordError" role="alert" aria-live="assertive"></div>
</div>

<div id="mainUI" role="main" aria-live="polite" aria-atomic="true">
  <button id="startBtn" aria-pressed="false">Démarrer</button>
  <button id="themeToggle" aria-pressed="false">Mode Clair</button>
  <div id="status">En attente...</div>
  <div id="clock" aria-label="Horloge">--:--:--</div>
  <audio id="reactionAudio" src="M/merci1.mp3" preload="auto"></audio>
</div>

<script>
(() => {
  const PASSWORD = "8629";

  const passwordScreen = document.getElementById("passwordScreen");
  const passwordInput = document.getElementById("passwordInput");
  const passwordSubmit = document.getElementById("passwordSubmit");
  const passwordError = document.getElementById("passwordError");

  const mainUI = document.getElementById("mainUI");
  const startBtn = document.getElementById("startBtn");
  const themeToggle = document.getElementById("themeToggle");
  const statusDiv = document.getElementById("status");
  const clock = document.getElementById("clock");
  const reactionAudio = document.getElementById("reactionAudio");

  let recognition = null;
  let isRunning = false;

  // Detect Android to disable continuous mode
  const isAndroid = /android/i.test(navigator.userAgent);

  function startRecognition() {
    if (recognition) {
      recognition.stop();
      recognition = null;
    }
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      alert("❌ Reconnaissance non supportée");
      return;
    }
    recognition = new SR();
    recognition.lang = "fr-FR";
    recognition.continuous = !isAndroid; // Disable continuous on Android
    recognition.interimResults = false;

    recognition.onresult = (e) => {
      const text = e.results[e.results.length - 1][0].transcript.trim();
      statusDiv.textContent = `🗣️ "${text}"`;
      recognition.stop();
      playReaction();
    };

    recognition.onend = () => {
      // On Android, wait for reaction audio to finish before restarting
      if (isRunning && !reactionAudio.paused) return;
      if (isRunning) recognition.start();
    };

    recognition.onerror = (e) => {
      console.error("Recognition error:", e.error);
      statusDiv.textContent = `Erreur micro: ${e.error}`;
      if (e.error === "not-allowed" || e.error === "service-not-allowed") {
        alert("❌ Permission micro refusée");
        isRunning = false;
        startBtn.textContent = "Démarrer";
        startBtn.setAttribute("aria-pressed", "false");
        statusDiv.textContent = "Permission refusée";
      }
    };

    try {
      recognition.start();
      statusDiv.textContent = "🎤 En écoute...";
    } catch {
      // Sometimes start throws if already started; ignore
    }
  }

  function stopRecognition() {
    if (recognition) {
      recognition.stop();
      recognition = null;
    }
  }

  function playReaction() {
    reactionAudio.play().catch(() => {});
    reactionAudio.onended = () => {
      if (isRunning) startRecognition();
    };
  }

  startBtn.onclick = () => {
    isRunning = !isRunning;
    if (isRunning) {
      navigator.mediaDevices.getUserMedia({ audio: true }).then(() => {
        startRecognition();
        startBtn.textContent = "Arrêter";
        startBtn.setAttribute("aria-pressed", "true");
      }).catch(e => {
        alert("❌ Micro refusé : " + e.message);
        isRunning = false;
        startBtn.textContent = "Démarrer";
        startBtn.setAttribute("aria-pressed", "false");
        statusDiv.textContent = "En pause.";
      });
    } else {
      stopRecognition();
      reactionAudio.pause();
      reactionAudio.currentTime = 0;
      startBtn.textContent = "Démarrer";
      startBtn.setAttribute("aria-pressed", "false");
      statusDiv.textContent = "En pause.";
    }
  };

  themeToggle.onclick = () => {
    if (document.body.getAttribute("data-theme") === "dark") {
      document.body.setAttribute("data-theme", "light");
      themeToggle.textContent = "Mode Sombre";
      themeToggle.setAttribute("aria-pressed", "true");
    } else {
      document.body.setAttribute("data-theme", "dark");
      themeToggle.textContent = "Mode Clair";
      themeToggle.setAttribute("aria-pressed", "false");
    }
  };

  passwordSubmit.onclick = () => {
    if (passwordInput.value === PASSWORD) {
      passwordError.textContent = "";
      passwordScreen.style.display = "none";
      mainUI.style.display = "flex";
      passwordInput.value = "";
      passwordInput.blur();
    } else {
      passwordError.textContent = "Code incorrect";
    }
  };

  passwordInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") passwordSubmit.click();
  });

  setInterval(() => {
    clock.textContent = new Date().toLocaleTimeString("fr-FR");
  }, 1000);
})();
</script>

</body>
</html>
