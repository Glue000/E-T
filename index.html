<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>E = T</title>
  <style>
    :root {
      --bg-color: #000000;
      --text-color: #ffffff;
      --button-bg: #333333;
      --button-hover: #555555;
      --input-bg: #222222;
      --input-text: #ffffff;
      --border-color: #444444;
    }
    [data-theme="light"] {
      --bg-color: #f0f0f0;
      --text-color: #111111;
      --button-bg: #dddddd;
      --button-hover: #bbbbbb;
      --input-bg: #ffffff;
      --input-text: #111111;
      --border-color: #cccccc;
    }
    body {
      background: var(--bg-color);
      color: var(--text-color);
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    h1 {
      margin-bottom: 1rem;
      font-weight: 700;
      font-size: 2.4rem;
    }
    button {
      margin: 10px 8px;
      padding: 14px 28px;
      font-size: 1.25rem;
      border: none;
      border-radius: 10px;
      background: var(--button-bg);
      color: var(--text-color);
      cursor: pointer;
      transition: background 0.3s;
      min-width: 140px;
      font-weight: 600;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
    }
    button:hover, button:focus {
      background: var(--button-hover);
      outline: none;
    }
    button:focus-visible {
      outline: 3px solid #00aaff;
      outline-offset: 2px;
    }
    input[type=range] {
      width: 160px;
      vertical-align: middle;
      background: var(--input-bg);
      -webkit-appearance: none;
      height: 8px;
      border-radius: 5px;
      margin-left: 10px;
      cursor: pointer;
      transition: background 0.3s;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #00aaff;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 5px rgba(0,170,255,0.7);
      transition: background 0.3s;
      margin-top: -7px;
    }
    input[type=range]:focus-visible::-webkit-slider-thumb {
      box-shadow: 0 0 10px #0088cc;
    }
    input[type=range]::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #00aaff;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 5px rgba(0,170,255,0.7);
      transition: background 0.3s;
    }
    input[type=range]:focus-visible::-moz-range-thumb {
      box-shadow: 0 0 10px #0088cc;
    }
    .vol-label {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 15px;
      font-size: 1.1rem;
      gap: 8px;
      user-select: none;
    }
    .vol-label span {
      min-width: 45px;
      text-align: left;
      font-variant-numeric: tabular-nums;
    }
    #status {
      margin-top: 30px;
      font-size: 1.4rem;
      font-weight: 600;
      min-height: 36px;
      user-select: none;
    }
    #clock {
      font-size: 2.4rem;
      margin-top: 30px;
      font-weight: 600;
      user-select: none;
      letter-spacing: 2px;
    }
    #themeToggle {
      margin-top: 30px;
      background: transparent;
      border: 2px solid var(--button-bg);
      color: var(--text-color);
      min-width: auto;
      padding: 10px 18px;
      font-size: 1rem;
      border-radius: 8px;
      box-shadow: none;
    }
    #themeToggle:hover, #themeToggle:focus {
      background: var(--button-bg);
      outline: none;
      box-shadow: 0 0 8px var(--button-hover);
    }
    #themeToggle:focus-visible {
      outline: 3px solid #00aaff;
      outline-offset: 2px;
    }

    /* Password screen styles */
    #passwordScreen {
      position: fixed;
      inset: 0;
      background: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 1.2rem;
      z-index: 1000;
    }
    #passwordInput {
      padding: 12px 16px;
      font-size: 1.4rem;
      border-radius: 8px;
      border: 2px solid var(--border-color);
      background: var(--input-bg);
      color: var(--input-text);
      width: 180px;
      text-align: center;
    }
    #passwordSubmit {
      padding: 12px 24px;
      font-size: 1.2rem;
      border-radius: 8px;
      border: none;
      background: var(--button-bg);
      color: var(--text-color);
      cursor: pointer;
      transition: background 0.3s;
      font-weight: 600;
    }
    #passwordSubmit:hover, #passwordSubmit:focus {
      background: var(--button-hover);
      outline: none;
    }
    #passwordSubmit:focus-visible {
      outline: 3px solid #00aaff;
      outline-offset: 2px;
    }
    #passwordError {
      color: #ff5555;
      min-height: 20px;
      font-weight: 600;
    }
    /* Hide main UI initially */
    #mainUI {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 100%;
      max-width: 500px;
    }
  </style>
</head>
<body data-theme="dark">

<!-- Password screen -->
<div id="passwordScreen" role="dialog" aria-modal="true" aria-labelledby="passwordTitle">
  <h2 id="passwordTitle">Entrez le code</h2>
  <input
    id="passwordInput"
    type="password"
    maxlength="4"
    autocomplete="off"
    inputmode="numeric"
    pattern="[0-9]*"
    aria-describedby="passwordError"
    aria-label="Code secret"
    autofocus
  />
  <button id="passwordSubmit">Valider</button>
  <div id="passwordError" role="alert" aria-live="assertive"></div>
</div>

<!-- Main UI hidden initially -->
<div id="mainUI" role="main" aria-live="polite" aria-atomic="true">
  <h1>E = T</h1>

  <button onclick="playClick(); toggleOverlay()" aria-label="Activer le mode plein √©cran">üï∂Ô∏è Plein √©cran</button>
  <button id="startBtn" onclick="playClick()" aria-pressed="false">D√©marrer</button>

  <div class="vol-label">
    üîä Volume R√©action :
    <input type="range" id="reactionVolume" min="0" max="1" step="0.01" value="1" aria-valuemin="0" aria-valuemax="1" aria-valuenow="1" aria-label="Volume des r√©actions audio" />
    <span id="reactionVal">1.00</span>
  </div>

  <div class="vol-label">
    üîî Volume Click :
    <input type="range" id="clickVolume" min="0" max="1" step="0.01" value="1" aria-valuemin="0" aria-valuemax="1" aria-valuenow="1" aria-label="Volume du son au clic" />
    <span id="clickVal">1.00</span>
  </div>

  <div class="vol-label">
    üéµ Volume Audio Mic Actif :
    <input type="range" id="micAudioVolume" min="0" max="1" step="0.01" value="0.3" aria-label="Volume de l'audio pendant que le micro est actif" />
    <span id="micAudioVal">0.30</span>
  </div>

  <div id="status" aria-live="polite" role="status">En attente...</div>
  <div id="clock" aria-label="Horloge">--:--:--</div>

  <button id="themeToggle" aria-pressed="false" aria-label="Changer le mode clair ou sombre">Changer Mode Clair/Sombre</button>
</div>

<audio id="clickSound" src="click.mp3" preload="auto"></audio>
<audio id="micActiveAudio" src="audio/mic_active_loop.mp3" preload="auto" loop></audio>

<script>
const PASSWORD = "8629";

const reactionAudios = ["M/merci1.mp3"];

const passwordScreen = document.getElementById("passwordScreen");
const passwordInput = document.getElementById("passwordInput");
const passwordSubmit = document.getElementById("passwordSubmit");
const passwordError = document.getElementById("passwordError");

const mainUI = document.getElementById("mainUI");
const startBtn = document.getElementById("startBtn");
const statusDiv = document.getElementById("status");
const clock = document.getElementById("clock");
const themeToggle = document.getElementById("themeToggle");

const reactionVol = document.getElementById("reactionVolume");
const clickVol = document.getElementById("clickVolume");
const micAudioVol = document.getElementById("micAudioVolume");

const reactionVal = document.getElementById("reactionVal");
const clickVal = document.getElementById("clickVal");
const micAudioVal = document.getElementById("micAudioVal");

const clickSound = document.getElementById("clickSound");
const micActiveAudio = document.getElementById("micActiveAudio");

let speakAudio = null;
let recognition = null;
let isRunning = false;

function updateAriaValue(input, span) {
  span.textContent = (+input.value).toFixed(2);
  input.setAttribute('aria-valuenow', (+input.value).toFixed(2));
}

reactionVol.oninput = () => {
  updateAriaValue(reactionVol, reactionVal);
};
clickVol.oninput = () => {
  updateAriaValue(clickVol, clickVal);
  clickSound.volume = +clickVol.value;
};
micAudioVol.oninput = () => {
  updateAriaValue(micAudioVol, micAudioVal);
  micActiveAudio.volume = +micAudioVol.value;
};

function playClick() {
  clickSound.currentTime = 0;
  clickSound.volume = +clickVol.value;
  clickSound.play().catch(() => {});
}

function stopRecognition() {
  if (recognition) {
    recognition.onend = null; // prevent restart
    recognition.stop();
    recognition = null;
  }
  micActiveAudio.pause();
}

function startRecognition() {
  if (recognition) {
    recognition.stop();
    recognition = null;
  }

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    alert("‚ùå Reconnaissance non support√©e");
    return;
  }

  recognition = new SR();
  recognition.lang = "fr-FR";
  recognition.continuous = true;
  recognition.interimResults = false;

  recognition.onresult = e => {
    const text = e.results[e.results.length - 1][0].transcript.trim().toLowerCase();
    statusDiv.textContent = `üó£Ô∏è "${text}"`;

    // User spoke, stop mic and play reaction
    stopRecognition();
    playReaction();
  };

  recognition.onend = () => {
    // Don't auto-restart; startRecognition called manually after reaction ends
  };

  recognition.onerror = event => {
    console.error("Recognition error:", event.error);
    if (event.error === "not-allowed" || event.error === "service-not-allowed") {
      alert("‚ùå Permission micro refus√©e");
      stopRecognition();
      isRunning = false;
      startBtn.textContent = "D√©marrer";
      startBtn.setAttribute("aria-pressed", "false");
      statusDiv.textContent = "Permission refus√©e";
    }
  };

  recognition.start();
  micActiveAudio.volume = +micAudioVol.value;
  micActiveAudio.play().catch(() => {});
}

function playReaction() {
  if (speakAudio) {
    speakAudio.pause();
    speakAudio = null;
  }

  micActiveAudio.pause();

  speakAudio = new Audio(reactionAudios[Math.floor(Math.random() * reactionAudios.length)]);
  speakAudio.volume = +reactionVol.value;
  speakAudio.play().catch(() => {});

  speakAudio.onended = () => {
    speakAudio = null;
    playClick();
    setTimeout(() => {
      if (isRunning) startRecognition();
    }, 300); // short delay before listening again
  };
}

startBtn.onclick = () => {
  playClick();
  isRunning = !isRunning;
  startBtn.textContent = isRunning ? "Arr√™ter" : "D√©marrer";
  startBtn.setAttribute("aria-pressed", isRunning.toString());
  if (isRunning) {
    navigator.mediaDevices.getUserMedia({ audio: true }).then(() => {
      startRecognition();
      statusDiv.textContent = "üé§ En √©coute...";
    }).catch(e => {
      alert("‚ùå Micro refus√© : " + e.message);
      isRunning = false;
      startBtn.textContent = "D√©marrer";
      startBtn.setAttribute("aria-pressed", "false");
      statusDiv.textContent = "En pause.";
    });
  } else {
    stopRecognition();
    speakAudio?.pause();
    statusDiv.textContent = "En pause.";
  }
};

function toggleOverlay() {
  alert("Mode plein √©cran non impl√©ment√© ici.");
}

themeToggle.onclick = () => {
  playClick();
  const currentTheme = document.body.getAttribute('data-theme');
  if (currentTheme === 'dark') {
    document.body.setAttribute('data-theme', 'light');
    themeToggle.textContent = "Mode Sombre";
    themeToggle.setAttribute("aria-pressed", "true");
  } else {
    document.body.setAttribute('data-theme', 'dark');
    themeToggle.textContent = "Mode Clair";
    themeToggle.setAttribute("aria-pressed", "false");
  }
};

// Password screen logic
passwordSubmit.onclick = () => {
  if (passwordInput.value === PASSWORD) {
    passwordError.textContent = "";
    passwordScreen.style.display = "none";
    mainUI.style.display = "flex";
    passwordInput.value = "";
    passwordInput.blur();
  } else {
    passwordError.textContent = "Code incorrect";
  }
};

// Allow pressing Enter in password field to submit
passwordInput.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    passwordSubmit.click();
  }
});

// Clock update
setInterval(() => {
  const now = new Date();
  clock.textContent = now.toLocaleTimeString("fr-FR");
}, 1000);
</script>

</body>
</html>
